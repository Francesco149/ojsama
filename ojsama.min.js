var osu={};if(typeof exports!=="undefined"){osu=exports}(function(){osu.VERSION_MAJOR=1;osu.VERSION_MINOR=0;osu.VERSION_PATCH=15;var h={warn:Function.prototype};if(typeof exports!=="undefined"){h=console}var t=function(t,i){var s=new Array(t.length);for(var e=0;e<s.length;++e){s[e]=t[e].toFixed(i)}return s};function R(t){return typeof t==="undefined"}function s(t){this.time=t.time||0;this.ms_per_beat=t.ms_per_beat;if(this.ms_per_beat===undefined){this.ms_per_beat=600}this.change=t.change;if(this.change===undefined){this.change=true}}s.prototype.toString=function(){return"{ time: "+this.time.toFixed(2)+", "+"ms_per_beat: "+this.ms_per_beat.toFixed(2)+" }"};var m={circle:1<<0,slider:1<<1,spinner:1<<3};function e(t){this.pos=t.pos||[0,0]}e.prototype.toString=function(){return"pos: ["+t(this.pos,2)+"]"};function r(t){this.pos=t.pos||[0,0];this.distance=t.distance||0;this.repetitions=t.repetitions||1}r.prototype.toString=function(){return"pos: "+t(this.pos,2)+", "+"distance: "+this.distance.toFixed(2)+", "+"repetitions: "+this.repetitions};function n(t){this.time=t.time||0;this.type=t.type||0;if(!R(t.data))this.data=t.data}n.prototype.typestr=function(){var t="";if(this.type&m.circle)t+="circle | ";if(this.type&m.slider)t+="slider | ";if(this.type&m.spinner)t+="spinner | ";return t.substring(0,Math.max(0,t.length-3))};n.prototype.toString=function(){return"{ time: "+this.time.toFixed(2)+", "+"type: "+this.typestr()+(this.data?", "+this.data.toString():"")+" }"};var a={std:0};function i(){this.reset()}i.prototype.reset=function(){this.format_version=1;this.mode=a.std;this.title=this.title_unicode="";this.artist=this.artist_unicode="";this.creator="";this.version="";this.ar=undefined;this.cs=this.od=this.hp=5;this.sv=this.tick_rate=1;this.ncircles=this.nsliders=this.nspinners=0;if(!this.objects){this.objects=[]}else{this.objects.length=0}if(!this.timing_points){this.timing_points=[]}else{this.timing_points.length=0}return this};i.prototype.max_combo=function(){var t=this.ncircles+this.nspinners;var i=-1;var s=Number.NEGATIVE_INFINITY;var e=0;for(var r=0;r<this.objects.length;++r){var n=this.objects[r];if(!(n.type&m.slider)){continue}while(n.time>=s){++i;if(this.timing_points.length>i+1){s=this.timing_points[i+1].time}else{s=Number.POSITIVE_INFINITY}var a=this.timing_points[i];var o=1;if(!a.change&&a.ms_per_beat<0){o=-100/a.ms_per_beat}if(this.format_version<8){e=this.sv*100}else{e=this.sv*100*o}}var h=n.data;var p=h.distance*h.repetitions/e;var c=Math.ceil((p-.1)/h.repetitions*this.tick_rate);--c;c*=h.repetitions;c+=h.repetitions+1;t+=Math.max(0,c)}return t};i.prototype.toString=function(){var t=this.artist+" - "+this.title+" [";if(this.title_unicode||this.artist_unicode){t+="("+this.artist_unicode+" - "+this.title_unicode+")"}t+=this.version+"] mapped by "+this.creator+"\n"+"\n"+"AR"+parseFloat(this.ar.toFixed(2))+" "+"OD"+parseFloat(this.od.toFixed(2))+" "+"CS"+parseFloat(this.cs.toFixed(2))+" "+"HP"+parseFloat(this.hp.toFixed(2))+"\n"+this.ncircles+" circles, "+this.nsliders+" sliders, "+this.nspinners+" spinners"+"\n"+this.max_combo()+" max combo"+"\n";return t};function o(){this.map=new i;this.reset()}o.prototype.reset=function(){this.map.reset();this.nline=0;this.curline="";this.lastpos="";this.section="";return this};o.prototype.feed_line=function(t){this.curline=this.lastpos=t;++this.nline;if(t.startsWith(" ")||t.startsWith("_")){return this}t=this.curline=t.trim();if(t.length<=0){return this}if(t.startsWith("//")){return this}if(t.startsWith("[")){if(this.section=="Difficulty"&&R(this.map.ar)){this.map.ar=this.map.od}this.section=t.substring(1,t.length-1);return this}if(!t){return this}switch(this.section){case"Metadata":this._metadata();break;case"General":this._general();break;case"Difficulty":this._difficulty();break;case"TimingPoints":this._timing_points();break;case"HitObjects":this._objects();break;default:var i=t.indexOf("file format v");if(i<0){break}this.map.format_version=parseInt(t.substring(i+13));break}return this};o.prototype.feed=function(t){var i=i=t.split("\n");for(var s=0;s<i.length;++s){this.feed_line(i[s])}return this};o.prototype.toString=function(){return"at line "+this.nline+"\n"+this.curline+"\n"+"-> "+this.lastpos+" <-"};o.prototype._setpos=function(t){this.lastpos=t.trim();return this.lastpos};o.prototype._warn=function(){h.warn.apply(null,Array.prototype.slice.call(arguments));h.warn(this.toString())};o.prototype._property=function(){var t=this.curline.split(":",2);t[0]=this._setpos(t[0]);t[1]=this._setpos(t[1]);return t};o.prototype._metadata=function(){var t=this._property();switch(t[0]){case"Title":this.map.title=t[1];break;case"TitleUnicode":this.map.title_unicode=t[1];break;case"Artist":this.map.artist=t[1];break;case"ArtistUnicode":this.map.artist_unicode=t[1];break;case"Creator":this.map.creator=t[1];break;case"Version":this.map.version=t[1];break}};o.prototype._general=function(){var t=this._property();if(t[0]!=="Mode"){return}this.map.mode=parseInt(this._setpos(t[1]))};o.prototype._difficulty=function(){var t=this._property();switch(t[0]){case"CircleSize":this.map.cs=parseFloat(this._setpos(t[1]));break;case"OverallDifficulty":this.map.od=parseFloat(this._setpos(t[1]));break;case"ApproachRate":this.map.ar=parseFloat(this._setpos(t[1]));break;case"HPDrainRate":this.map.hp=parseFloat(this._setpos(t[1]));break;case"SliderMultiplier":this.map.sv=parseFloat(this._setpos(t[1]));break;case"SliderTickRate":this.map.tick_rate=parseFloat(this._setpos(t[1]));break}};o.prototype._timing_points=function(){var t=this.curline.split(",");if(t.length>8){this._warn("timing point with trailing values")}else if(t.length<2){this._warn("ignoring malformed timing point");return}var i=new s({time:parseFloat(this._setpos(t[0])),ms_per_beat:parseFloat(this._setpos(t[1]))});if(t.length>=7){i.change=t[6].trim()!=="0"}this.map.timing_points.push(i)};o.prototype._objects=function(){var t=this.curline.split(",");var i;if(t.length>11){this._warn("object with trailing values")}else if(t.length<4){this._warn("ignoring malformed hitobject");return}var s=new n({time:parseFloat(this._setpos(t[2])),type:parseInt(this._setpos(t[3]))});if(isNaN(s.time)||isNaN(s.type)){this._warn("ignoring malformed hitobject");return}if((s.type&m.circle)!=0){++this.map.ncircles;i=s.data=new e({pos:[parseFloat(this._setpos(t[0])),parseFloat(this._setpos(t[1]))]});if(isNaN(i.pos[0])||isNaN(i.pos[1])){this._warn("ignoring malformed circle");return}}else if((s.type&osu.objtypes.spinner)!=0){++this.map.nspinners}else if((s.type&osu.objtypes.slider)!=0){if(t.length<8){this._warn("ignoring malformed slider");return}++this.map.nsliders;i=s.data=new r({pos:[parseFloat(this._setpos(t[0])),parseFloat(this._setpos(t[1]))],repetitions:parseInt(this._setpos(t[6])),distance:parseFloat(this._setpos(t[7]))});if(isNaN(i.pos[0])||isNaN(i.pos[1])||isNaN(i.repetitions)||isNaN(i.distance)){this._warn("ignoring malformed slider");return}}this.map.objects.push(s)};var z={nomod:0,nf:1<<0,ez:1<<1,td:1<<2,hd:1<<3,hr:1<<4,dt:1<<6,ht:1<<8,nc:1<<9,fl:1<<10,so:1<<12};z.from_string=function(t){var i=0;t=t.toLowerCase();while(t!=""){var s=1;for(var e in z){if(e.length!=2){continue}if(!z.hasOwnProperty(e)){continue}if(t.startsWith(e)){i|=z[e];s=2;break}}t=t.slice(s)}return i};z.string=function(t){var i="";for(var s in z){if(s.length!=2){continue}if(!z.hasOwnProperty(s)){continue}if(t&z[s]){i+=s.toUpperCase()}}if(i.indexOf("DT")>=0&&i.indexOf("NC")>=0){i=i.replace("DT","")}return i};z.speed_changing=z.dt|z.ht|z.nc;z.map_changing=z.hr|z.ez|z.speed_changing;var p=79.5;var c=19.5;var l=1800;var u=1200;var f=450;var d=(p-c)/10;var _=(l-u)/5;var v=(u-f)/5;function g(t,i,s){var e=t;e*=s;var r=e<5?l-_*e:u-v*(e-5);r=Math.min(l,Math.max(f,r));r/=i;e=r>u?(l-r)/_:5+(u-r)/v;return e}function b(t,i,s){var e=t;e*=s;var r=p-Math.ceil(d*e);r=Math.min(p,Math.max(c,r));r/=i;e=(p-r)/d;return e}function C(t){this.ar=t.ar;this.od=t.od;this.hp=t.hp;this.cs=t.cs;this.speed_mul=1;this._mods_cache={}}C.prototype.with_mods=function(t){if(this._mods_cache[t]){return this._mods_cache[t]}var i=this._mods_cache[t]=new C(this);if(!(t&z.map_changing)){return i}if(t&(z.dt|z.nc))i.speed_mul=1.5;if(t&z.ht)i.speed_mul*=.75;var s=1;if(t&z.hr)s=1.4;if(t&z.ez)s*=.5;if(i.ar){i.ar=g(i.ar,i.speed_mul,s)}if(i.od){i.od=b(i.od,i.speed_mul,s)}if(i.cs){if(t&z.hr)i.cs*=1.3;if(t&z.ez)i.cs*=.5;i.cs=Math.min(10,i.cs)}if(i.hp){i.hp*=s;i.hp=Math.min(10,i.hp)}return i};function y(t){this.obj=t;this.reset()}y.prototype.reset=function(){this.strains=[0,0];this.normpos=[0,0];this.is_single=false;return this};y.prototype.toString=function(){return"{ strains: ["+t(this.strains,2)+"], normpos: ["+t(this.normpos,2)+"], is_single: "+this.is_single+" }"};function w(t,i){return[t[0]-i[0],t[1]-i[1]]}function M(t,i){return[t[0]*i[0],t[1]*i[1]]}function j(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1])}var x=0;var F=1;var N=90;var k=110;var I=125;var S=[.3,.15];var T=[1400,26.25];var E=.9;var O=400;var A=30;var D=.0675;var P=[512,384];var q=M(P,[.5,.5]);var V=.5;function W(){this.objects=[];this.reset();this.map=undefined;this.mods=z.nomod;this.singletap_threshold=125}W.prototype.reset=function(){this.total=0;this.aim=0;this.speed=0;this.nsingles=0;this.nsingles_threshold=0};W.prototype.calc=function(t){var i=this.map=t.map||this.map;if(!i){throw new TypeError("no map given")}var s=this.mods=t.mods||this.mods;var e=this.singletap_threshold=t.singletap_threshold||e;var r=new C({cs:i.cs}).with_mods(s);var n=r.speed_mul;this._init_objects(this.objects,i,r.cs);this.speed=this._calc_individual(x,this.objects,n);this.aim=this._calc_individual(F,this.objects,n);this.speed=Math.sqrt(this.speed)*D;this.aim=Math.sqrt(this.aim)*D;if(s&z.td){this.aim=Math.pow(this.aim,.8)}this.total=this.aim+this.speed+Math.abs(this.speed-this.aim)*V;this.nsingles=0;this.nsingles_threshold=0;for(var a=1;a<this.objects.length;++a){var o=this.objects[a].obj;var h=this.objects[a-1].obj;if(this.objects[a].is_single){++this.nsingles}if(!(o.type&(m.circle|m.slider))){continue}var p=(o.time-h.time)/n;if(p>=e){++this.nsingles_threshold}}return this};W.prototype.toString=function(){return this.total.toFixed(2)+" stars ("+this.aim.toFixed(2)+" aim, "+this.speed.toFixed(2)+" speed)"};W.prototype._spacing_weight=function(t,i){switch(t){case F:return Math.pow(i,.99);case x:if(i>I){return 2.5}else if(i>k){return 1.6+.9*(i-k)/(I-k)}else if(i>N){return 1.2+.4*(i-N)/(k-N)}else if(i>N/2){return.95+.25*(i-N/2)/(N/2)}return.95}throw{name:"NotImplementedError",message:"this difficulty type does not exist"}};W.prototype._calc_strain=function(t,i,s,e){var r=i.obj;var n=s.obj;var a=0;var o=(r.time-n.time)/e;var h=Math.pow(S[t],o/1e3);if((r.type&(m.slider|m.circle))!=0){var p=j(w(i.normpos,s.normpos));if(t==x){i.is_single=p>I}a=this._spacing_weight(t,p);a*=T[t]}a/=Math.max(o,50);i.strains[t]=s.strains[t]*h+a};W.prototype._calc_individual=function(t,i,s){var e=[];var r=O*s;var n=r;var a=0;var o;for(o=0;o<i.length;++o){if(o>0){this._calc_strain(t,i[o],i[o-1],s)}while(i[o].obj.time>n){e.push(a);if(o>0){var h=Math.pow(S[t],(n-i[o-1].obj.time)/1e3);a=i[o-1].strains[t]*h}else{a=0}n+=r}a=Math.max(a,i[o].strains[t])}var p=1;var c=0;e.sort(function(t,i){return i-t});for(o=0;o<e.length;++o){c+=e[o]*p;p*=E}return c};W.prototype._normalizer_vector=function(t){var i=P[0]/16*(1-.7*(t-5)/5);var s=52/i;if(i<A){s*=1+Math.min(A-i,5)/50}return[s,s]};W.prototype._init_objects=function(t,i,s){if(t.length!=i.objects.length){t.length=i.objects.length}var e=this._normalizer_vector(s);var r=M(q,e);for(var n=0;n<t.length;++n){if(!t[n]){t[n]=new y(i.objects[n])}else{t[n].reset()}var a=t[n].obj;if(a.type&m.spinner){t[n].normpos=r.slice();continue}var o;if(a.type&(m.slider|m.circle)){o=a.data.pos}else{h.warn("unknown object type ",a.type.toString(16));o=[0,0]}t[n].normpos=M(o,e)}};function H(){this.calculators=[];this.map=undefined}H.prototype.calc=function(t){var i;var s=this.map=t.map||this.map;if(!s){throw new TypeError("no map given")}if(!this.calculators[s.mode]){switch(s.mode){case a.std:i=new W;break;default:throw{name:"NotImplementedError",message:"this gamemode is not yet supported"}}this.calculators[s.mode]=i}else{i=this.calculators[s.mode]}return i.calc(t)};function U(t){this.nmiss=t.nmiss||0;if(t.n300===undefined){this.n300=-1}else{this.n300=t.n300}this.n100=t.n100||0;this.n50=t.n50||0;if(t.percent){var i=t.nobjects;if(i===undefined){throw new TypeError("nobjects is required when specifying percent")}this.nmiss=Math.min(i,this.nmiss);var s=i-this.nmiss;var e=new U({n300:s,n100:0,n50:0,nmiss:this.nmiss}).value()*100;var r=t.percent;r=Math.max(0,Math.min(e,r));this.n100=Math.round(-3*((r*.01-1)*i+this.nmiss)*.5);if(this.n100>s){this.n100=0;this.n50=Math.round(-6*((r*.01-1)*i+this.nmiss)*.5);this.n50=Math.min(s,this.n50)}this.n300=i-this.n100-this.n50-this.nmiss}}U.prototype.value=function(t){var i=this.n300;if(i<0){if(!t){throw new TypeError("either n300 or nobjects must be specified")}i=t-this.n100-this.n50-this.nmiss}else{t=i+this.n100+this.n50+this.nmiss}var s=(i*300+this.n100*100+this.n50*50)/(t*300);return Math.max(0,Math.min(s,1))};U.prototype.toString=function(){return(this.value()*100).toFixed(2)+"% "+this.n100+"x100 "+this.n50+"x50 "+this.nmiss+"xmiss"};function G(){this.aim=0;this.speed=0;this.acc=0;this.computed_accuracy=undefined}G.prototype.calc=function(t){var i=t.stars;var s=t.map;var e,r,n,a,o,h;var p;var c,m;if(i){s=i.map}if(s){e=s.max_combo();r=s.nsliders;n=s.ncircles;a=s.objects.length;o=s.ar;h=s.od;if(!i){i=(new W).calc(t)}}else{e=t.max_combo;if(!e||e<0){throw new TypeError("max_combo must be > 0")}r=t.nsliders;n=t.ncircles;a=t.nobjects;if([r,n,a].some(isNaN)){throw new TypeError("nsliders, ncircles, nobjects are required (must be numbers) ")}if(a<r+n){throw new TypeError("nobjects must be >= nsliders + ncircles")}o=t.base_ar;if(R(o))o=5;h=t.base_od;if(R(h))h=5}if(i){p=i.mods;c=i.aim;m=i.speed}else{p=t.mods||z.nomod;c=t.aim_stars;m=t.speed_stars}if([c,m].some(isNaN)){throw new TypeError("aim and speed stars required (must be numbers)")}var l=t.nmiss||0;var u=t.n50||0;var f=t.n100||0;var d=t.n300;if(d===undefined)d=a-f-u-l;var _=t.combo;if(_===undefined)_=e-l;var v=t.score_version||1;var g=a/2e3;var b=.95+.4*Math.min(1,g);if(a>2e3){b+=Math.log10(g)*.5}var y=Math.pow(.97,l);var w=Math.pow(_,.8)/Math.pow(e,.8);var M=new C({ar:o,od:h}).with_mods(p);this.computed_accuracy=new U({percent:t.acc_percent,nobjects:a,n300:d,n100:f,n50:u,nmiss:l});d=this.computed_accuracy.n300;f=this.computed_accuracy.n100;u=this.computed_accuracy.n50;var j=this.computed_accuracy.value();var x=1;if(M.ar>10.33){x+=.45*(M.ar-10.33)}else if(M.ar<8){var F=.01*(8-M.ar);if(p&z.hd){F*=2}x+=F}var N=this._base(c);N*=b;N*=y;N*=w;N*=x;if(p&z.hd)N*=1.03;if(p&z.fl)N*=1.45*b;var k=.5+j/2;var I=.98+M.od*M.od/2500;N*=k;N*=I;this.aim=N;var S=this._base(m);S*=b;S*=y;S*=w;S*=k;S*=I;if(p&z.hd)S*=1.18;this.speed=S;var T=j;switch(v){case 1:var E=a-r-n;T=new U({n300:Math.max(0,d-r-E),n100:f,n50:u,nmiss:l}).value();T=Math.max(0,T);break;case 2:n=a;break;default:throw new{name:"NotImplementedError",message:"unsupported scorev"+v}}var O=Math.pow(1.52163,M.od)*Math.pow(T,24)*2.83;O*=Math.min(1.15,Math.pow(n/1e3,.3));if(p&z.hd)O*=1.02;if(p&z.fl)O*=1.02;this.acc=O;var A=1.12;if(p&z.nf)A*=.9;if(p&z.so)A*=.95;this.total=Math.pow(Math.pow(N,1.1)+Math.pow(S,1.1)+Math.pow(O,1.1),1/1.1)*A;return this};G.prototype.toString=function(){return this.total.toFixed(2)+" pp ("+this.aim.toFixed(2)+" aim, "+this.speed.toFixed(2)+" speed, "+this.acc.toFixed(2)+" acc)"};G.prototype._base=function(t){return Math.pow(5*Math.max(1,t/.0675)-4,3)/1e5};function Y(t){var i;if(t.map){i=t.map.mode}else{i=t.mode||a.std}switch(i){case a.std:return(new G).calc(t)}throw{name:"NotImplementedError",message:"this gamemode is not yet supported"}}osu.timing=s;osu.objtypes=m;osu.circle=e;osu.slider=r;osu.hitobject=n;osu.modes=a;osu.beatmap=i;osu.parser=o;osu.modbits=z;osu.std_beatmap_stats=C;osu.std_diff_hitobject=y;osu.std_diff=W;osu.diff=H;osu.std_accuracy=U;osu.std_ppv2=G;osu.ppv2=Y})();